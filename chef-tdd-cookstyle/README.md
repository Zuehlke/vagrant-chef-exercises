
## Chef TDD: Ruby-level Linting with Cookstyle

Lint checks find easy to catch bugs and ensure a consistent coding style. For linting Chef cookbooks
on Ruby code level you usually use:

 * https://docs.chef.io/cookstyle.html

### Running Cookstyle Linting

The first thing to run is `rake cookstyle`:
```
$ rake cookstyle
cookstyle .
Inspecting 7 files
C......

Offenses:

Rakefile:22:6: C: Style/HashSyntax: Use the new Ruby 1.9 hash syntax.
task :unit => [:cookstyle, :foodcritic, :chefspec]
     ^^^^^^^^
Rakefile:22:51: C: Layout/TrailingBlankLines: Final newline missing.
task :unit => [:cookstyle, :foodcritic, :chefspec]
                                                  

7 files inspected, 2 offenses detected
rake aborted!
Command failed with status (1): [cookstyle ....]
/home/user/vagrant-chef-exercises/tdd-myapp/cookbooks/myapp/Rakefile:3:in `block in <top (required)>'
Tasks: TOP => cookstyle
(See full trace by running task with --trace)
```

And ooops, it already found something in our `Rakefile`. We are using the outdated Ruby 1.9 syntax here and should use the Ruby 2.0 syntax instead.

### Manual Correction

We could simply correct that manually in our `Rakefile`:
```ruby
task unit: [:cookstyle, :foodcritic, :chefspec]

```

Now tha we run cookstyle again:
```
$ rake cookstyle
cookstyle .
Inspecting 7 files
.......

7 files inspected, no offenses detected
```

### Auto-Correction

Another option would have been to auto-correct the offenses that cookstyle finds. In order to do that, you would have run `cookstyle --auto-correct` instead:
```
$ cookstyle --auto-correct
Inspecting 7 files
C......

Offenses:

Rakefile:22:6: C: [Corrected] Style/HashSyntax: Use the new Ruby 1.9 hash syntax.
task :unit => [:cookstyle, :foodcritic, :chefspec]
     ^^^^^^^^
Rakefile:22:51: C: [Corrected] Layout/TrailingBlankLines: Final newline missing.
task :unit => [:cookstyle, :foodcritic, :chefspec]
                                                  

7 files inspected, 2 offenses detected, 2 offenses corrected
```

### Exclusions

Finally, we could also have excluded specific rules or even complete files via a `.rubocop.yml` configuration file,
e.g. like this one:
```yaml
Metrics/LineLength:
  Max: 120

Layout/EmptyLinesAroundBlockBody:
  Enabled: false

AllCops:
  Exclude:
    - Rakefile
```

This excludes the Rakefile generally, allows line-length to exceed the 80 chars default, and lets me put an empty line before a block of code. That's just my gusto and YMMV ;-)  

This would also make it pass again:
```
$ rake cookstyle
cookstyle .
Inspecting 6 files
......

6 files inspected, no offenses detected
```

### A Note on Legacy Projects

When introducing cookstyle to legacy projects it  will probably find lots of offenses. The easiest way to deal with that is to "generate a configuration file acting as a TODO list" via the `--auto-gen-config` option (see `cookstyle --help`):
```
$ cookstyle --auto-gen-config
Added inheritance from `.rubocop_todo.yml` in `.rubocop.yml`.
Phase 1 of 2: run Metrics/LineLength cop
Inspecting 7 files
...C...

7 files inspected, 1 offense detected
Created .rubocop_todo.yml.
Phase 2 of 2: run all cops
Inspecting 7 files
C......

7 files inspected, 2 offenses detected
Created .rubocop_todo.yml.
```

This would generate a `.rubocop_todo.yml` config with suggestions like these:
```yaml
# This configuration was generated by
# `rubocop --auto-gen-config`
# on 2019-05-14 23:59:41 +0200 using RuboCop version 0.55.0.
# The point is for the user to remove these configuration records
# one by one as the offenses are removed from the code base.
# Note that changes in the inspected code, or installation of new
# versions of RuboCop, may require this file to be generated again.

# Offense count: 1
# Cop supports --auto-correct.
# Configuration parameters: EnforcedStyle.
# SupportedStyles: final_newline, final_blank_line
Layout/TrailingBlankLines:
  Exclude:
    - 'Rakefile'

# Offense count: 1
# Cop supports --auto-correct.
# Configuration parameters: EnforcedStyle, UseHashRocketsWithSymbolValues, PreferHashRocketsForNonAlnumEndingSymbols.
# SupportedStyles: ruby19, hash_rockets, no_mixed_keys, ruby19_no_mixed_keys
Style/HashSyntax:
  Exclude:
    - 'Rakefile'

# Offense count: 1
# Configuration parameters: AllowHeredoc, AllowURI, URISchemes, IgnoreCopDirectives, IgnoredPatterns.
# URISchemes: http, https
Metrics/LineLength:
  Max: 82
```
